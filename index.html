<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Admin Core</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;700;900&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">

    <!-- Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --bg: #090a0f;
            --irid-1: rgba(186, 255, 255, 0.15);
            --irid-2: rgba(255, 186, 255, 0.15);
            --irid-3: rgba(255, 255, 186, 0.1);
            --cellulose-white: rgba(255, 255, 255, 0.04);
            --border: rgba(255, 255, 255, 0.08);
            --text-main: #f0f0f0;
            --text-mono: #a0a0a0;
            --accent: #00f2ff;

            /* Status Colors */
            --color-success: #00ff9d;
            --color-warning: #ffcc00;
            --color-danger: #ff0055;
            --color-info: #00ccff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
        }

        body {
            background-color: var(--bg);
            background-image:
                radial-gradient(circle at 20% 20%, var(--irid-1) 0%, transparent 40%),
                radial-gradient(circle at 80% 80%, var(--irid-2) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, var(--irid-3) 0%, transparent 60%);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* The Cellulose Grain Overlay */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
            opacity: 0.25;
            filter: url(#cellulose-noise);
        }

        aside {
            width: 80px;
            height: 100vh;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 0;
            gap: 20px;
            z-index: 10;
            background: rgba(9, 10, 15, 0.5);
            backdrop-filter: blur(10px);
        }

        .logo {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #fff, #555);
            border-radius: 50%;
            margin-bottom: 20px;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.3));
        }

        .nav-item {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            color: var(--text-mono);
        }

        .nav-item:hover,
        .nav-item.active {
            background: var(--cellulose-white);
            backdrop-filter: blur(10px);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5), inset 0 0 0 1px var(--border);
        }

        .nav-tooltip {
            position: absolute;
            left: 70px;
            background: var(--bg);
            border: 1px solid var(--border);
            padding: 5px 10px;
            border-radius: 4px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 20;
        }

        .nav-item:hover .nav-tooltip {
            opacity: 1;
        }

        main {
            flex: 1;
            padding: 60px;
            overflow-y: auto;
            position: relative;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 60px;
        }

        .header h1 {
            font-weight: 900;
            font-size: 3rem;
            letter-spacing: -2px;
            text-transform: uppercase;
            line-height: 0.9;
        }

        .header .mono-stats {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: var(--text-mono);
            text-align: right;
            border-left: 1px solid var(--border);
            padding-left: 20px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-gap: 30px;
            margin-bottom: 50px;
        }

        /* Utilities */
        .hidden {
            display: none !important;
        }

        .full-width {
            grid-column: span 12;
        }

        .cellulose-card {
            background: var(--cellulose-white);
            backdrop-filter: blur(25px) saturate(150%);
            border: 1px solid var(--border);
            border-radius: 2px;
            padding: 30px;
            position: relative;
            overflow: hidden;
            transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .cellulose-card:hover {
            transform: translateY(-2px);
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* Iridescent Sheen */
        .cellulose-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.03), transparent);
            transform: rotate(45deg);
            transition: 0.8s;
            pointer-events: none;
        }

        .cellulose-card:hover::after {
            left: 100%;
        }

        .card-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--accent);
            margin-bottom: 15px;
            display: block;
            letter-spacing: 2px;
        }

        .card-value {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .large-pane {
            grid-column: span 8;
        }

        .small-pane {
            grid-column: span 4;
        }

        .half-pane {
            grid-column: span 6;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
        }

        .data-table th {
            text-align: left;
            color: var(--text-mono);
            padding: 15px 10px;
            border-bottom: 1px solid var(--border);
            font-weight: 400;
            text-transform: uppercase;
            font-size: 0.75rem;
        }

        .data-table td {
            padding: 18px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            vertical-align: middle;
        }

        .data-table td img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            vertical-align: middle;
            margin-right: 10px;
            filter: grayscale(0.5);
            transition: filter 0.3s;
        }

        .data-table tr:hover td img {
            filter: grayscale(0);
        }

        .status-tag {
            padding: 4px 10px;
            border: 1px solid var(--border);
            color: var(--text-mono);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: inline-block;
        }

        .status-success {
            border-color: var(--color-success);
            color: var(--color-success);
            background: rgba(0, 255, 157, 0.05);
        }

        .status-warning {
            border-color: var(--color-warning);
            color: var(--color-warning);
            background: rgba(255, 204, 0, 0.05);
        }

        .status-danger {
            border-color: var(--color-danger);
            color: var(--color-danger);
            background: rgba(255, 0, 85, 0.05);
        }

        /* Forms & Inputs */
        input,
        select {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 10px 15px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            width: 100%;
            outline: none;
            transition: border-color 0.3s;
            margin-top: 5px;
        }

        input:focus,
        select:focus {
            border-color: var(--accent);
        }

        label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-mono);
            text-transform: uppercase;
        }

        button.btn-primary {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 10px 20px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
        }

        button.btn-primary:hover {
            box-shadow: 0 0 15px var(--accent);
        }

        button.btn-secondary {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-mono);
            padding: 10px 20px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
        }

        button.btn-secondary:hover {
            border-color: var(--text-main);
            color: var(--text-main);
        }

        /* Modal */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal-content {
            background: #0f1115;
            border: 1px solid var(--border);
            padding: 40px;
            width: 100%;
            max-width: 500px;
            transform: translateY(20px);
            transition: transform 0.3s;
        }

        .modal-active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-active .modal-content {
            transform: translateY(0);
        }

        /* Animations */
        @keyframes reveal {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .reveal {
            animation: reveal 1s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        .delay-1 {
            animation-delay: 0.1s;
        }

        .delay-2 {
            animation-delay: 0.2s;
        }

        .delay-3 {
            animation-delay: 0.3s;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }

        /* --- BATCH DELETE UI --- */
        .select-checkbox {
            display: none;
            width: 18px;
            height: 18px;
            border: 2px solid var(--text-mono);
            border-radius: 4px;
            margin-right: 15px;
            cursor: pointer;
            position: relative;
            vertical-align: middle;
        }

        .selection-mode .select-checkbox {
            display: inline-block;
        }

        .select-checkbox.checked {
            border-color: var(--accent);
            background: rgba(0, 242, 255, 0.2);
        }

        .select-checkbox.checked::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 10px;
            height: 10px;
            background: var(--accent);
            border-radius: 2px;
        }

        .row-selected {
            background: rgba(0, 242, 255, 0.05) !important;
        }

        .fab-container {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #111;
            border: 1px solid var(--border);
            padding: 15px 30px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0;
            pointer-events: none;
        }

        .fab-active {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        .fab-counter {
            font-family: 'JetBrains Mono';
            font-weight: bold;
            color: var(--text-main);
            border-right: 1px solid var(--border);
            padding-right: 20px;
        }

        .confirm-danger {
            color: var(--color-danger);
            border: 1px solid var(--color-danger);
            background: rgba(255, 0, 85, 0.1);
        }

        /* Schedule Tabs */
        .schedule-tab {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-mono);
            padding: 12px 24px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            font-size: 0.75rem;
            letter-spacing: 1px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .schedule-tab:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(0, 242, 255, 0.05);
        }

        .schedule-tab.active-tab {
            border-color: var(--accent);
            color: #000;
            background: var(--accent);
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.3);
        }

        .schedule-content {
            animation: reveal 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
    </style>
</head>

<body>

    <svg style="display:none;">
        <filter id="cellulose-noise">
            <feTurbulence type="fractalNoise" baseFrequency="0.6" numOctaves="3" stitchTiles="stitch" />
            <feColorMatrix type="saturate" values="0" />
            <feComponentTransfer>
                <feFuncR type="linear" slope="0.1" />
                <feFuncG type="linear" slope="0.1" />
                <feFuncB type="linear" slope="0.1" />
            </feComponentTransfer>
        </filter>
    </svg>

    <div id="login-screen"
        style="position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg); z-index:1000; display:flex; align-items:center; justify-content:center; flex-direction:column;">
        <div class="cellulose-card" style="width:100%; max-width:400px; text-align:center;">
            <div class="logo" style="margin:0 auto 20px auto; width:64px; height:64px;"></div>
            <h2 style="margin-bottom:10px; text-transform:uppercase; letter-spacing:2px;">Nexus Access</h2>
            <p style="color:var(--text-mono); font-size:0.8rem; margin-bottom:30px;">SECURE ADMIN TERMINAL</p>

            <form id="login-form" onsubmit="handleLogin(event)">
                <div style="margin-bottom:15px; text-align:left;">
                    <label>Admin ID</label>
                    <input type="email" id="login-email" required placeholder="admin@nexus.com"
                        style="background:rgba(0,0,0,0.5);">
                </div>
                <div style="margin-bottom:25px; text-align:left;">
                    <label>Passkey</label>
                    <input type="password" id="login-password" required placeholder="••••••••"
                        style="background:rgba(0,0,0,0.5);">
                </div>
                <div id="login-error"
                    style="color:var(--color-danger); font-size:0.8rem; margin-bottom:15px; display:none;"></div>
                <button type="submit" class="btn-primary" style="width:100%;">AUTHENTICATE</button>
            </form>
        </div>
    </div>

    <!-- Protected Content (Hidden by default) -->
    <div id="app-content" style="display:none; width:100%; height:100%; display:flex;">
        <aside>
            <div class="logo"></div>
            <nav style="display: flex; flex-direction: column; gap: 10px;">
                <div class="nav-item active" onclick="navigate('dashboard')" title="Dashboard">
                    <i data-lucide="hexagon" width="20"></i>
                </div>
                <div class="nav-item" onclick="navigate('all_orders')" title="Orders">
                    <i data-lucide="list" width="20"></i>
                </div>
                <div class="nav-item" onclick="navigate('users')" title="Users">
                    <i data-lucide="users" width="20"></i>
                </div>
                <div class="nav-item" onclick="navigate('add_product')" title="Products">
                    <i data-lucide="package" width="20"></i>
                </div>
                <div class="nav-item" onclick="navigate('add_address')" title="Locations">
                    <i data-lucide="map-pin" width="20"></i>
                </div>
                <div class="nav-item" onclick="navigate('schedule')" title="Schedule">
                    <i data-lucide="calendar" width="20"></i>
                </div>
                <div class="nav-item" onclick="navigate('support')" title="Support">
                    <i data-lucide="message-circle" width="20"></i>
                </div>
            </nav>
        </aside>

        <main>
            <div class="header reveal">
                <div>
                    <p
                        style="font-family:'JetBrains Mono'; font-size: 0.9rem; color: var(--accent); margin-bottom: 10px;">
                        SYSTEM STATUS: ONLINE</p>
                    <h1 id="page-title">Core Architecture</h1>
                </div>
                <div class="mono-stats">
                    NEXUS ADMIN V2.1<br>
                    SECURE SESSION<br>
                    <a href="#" onclick="handleLogout()"
                        style="color:var(--color-danger); text-decoration:none; border-bottom:1px dotted var(--color-danger);">TERMINATE
                        SESSION</a>
                </div>
            </div>

            <!-- DASHBOARD VIEW -->
            <div id="view-dashboard" class="dashboard-grid reveal delay-1">
                <div class="cellulose-card small-pane">
                    <span class="card-label">Total Revenue</span>
                    <div class="card-value" id="stat-revenue">₹0</div>
                    <div style="font-family:'JetBrains Mono'; color: var(--text-mono); font-size: 0.75rem;">Aggregated
                        Global Sales</div>
                </div>

                <div class="cellulose-card small-pane delay-1">
                    <span class="card-label">Active Users</span>
                    <div class="card-value" id="stat-users">0</div>
                    <div style="font-family:'JetBrains Mono'; color: #00ff88; font-size: 0.75rem;">+12.4% Growth</div>
                </div>

                <div class="cellulose-card small-pane delay-2">
                    <span class="card-label">Pending Orders</span>
                    <div class="card-value" id="stat-pending">0</div>
                    <div style="font-family:'JetBrains Mono'; color: var(--color-warning); font-size: 0.75rem;">Action
                        Required</div>
                </div>

                <div class="cellulose-card large-pane" style="grid-row: span 2;">
                    <span class="card-label">Recent Transactions</span>
                    <div class="overflow-x: auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Date</th>
                                    <th>Items</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-txns"></tbody>
                        </table>
                    </div>
                </div>

                <div class="cellulose-card small-pane delay-3">
                    <span class="card-label">Analytics</span>
                    <div style="height: 150px; position:relative;">
                        <canvas id="miniRevenueChart"></canvas>
                    </div>
                </div>
                <div class="cellulose-card small-pane delay-3">
                    <span class="card-label">Order Volume</span>
                    <div style="height: 150px; position:relative;">
                        <canvas id="miniVolumeChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- ORDERS VIEW -->
            <div id="view-orders" class="hidden reveal">
                <div class="cellulose-card full-width">
                    <div
                        style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; gap: 20px;">
                        <span class="card-label">Order Registry</span>
                        <div style="display:flex; gap:15px; align-items:center; flex:1; justify-content:flex-end;">
                            <!-- Search Box -->
                            <div style="position:relative; flex:0 1 300px;">
                                <input type="text" id="order-search" placeholder="Search by Order ID..."
                                    oninput="applyOrderFilters()"
                                    style="width:100%; padding:8px 12px 8px 35px; font-size:0.8rem; background:rgba(0,0,0,0.3); border:1px solid var(--border); border-radius:4px;">
                                <i data-lucide="search"
                                    style="position:absolute; left:10px; top:50%; transform:translateY(-50%); width:16px; color:var(--text-mono); pointer-events:none;"></i>
                            </div>

                            <!-- Filter Dropdown -->
                            <div
                                style="font-family:'JetBrains Mono'; font-size:0.8rem; color:var(--text-mono); white-space:nowrap;">
                                FILTER:
                                <select id="order-filter" onchange="applyOrderFilters()"
                                    style="display:inline-block; width:auto; background:transparent; border:none; color:var(--accent); font-weight:bold; padding:0 5px; cursor:pointer;">
                                    <option value="all">ALL ORDERS</option>
                                    <option value="pick-later">PICK LATER</option>
                                    <option value="delivery-later">DELIVERY LATER</option>
                                    <option value="aborted">ABORTED</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Date</th>
                                <th>Items</th>
                                <th>Address</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Protocol</th>
                                <th>Dtl</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- USERS VIEW -->
            <div id="view-users" class="hidden reveal">
                <div class="cellulose-card full-width">
                    <span class="card-label">User Database</span>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Avatar</th>
                                <th>Identity</th>
                                <th>Contact</th>
                                <th>Location</th>
                                <th>LTV Value</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- PRODUCTS VIEW -->
            <div id="view-products" class="hidden reveal">
                <div style="display:flex; justify-content:flex-end; margin-bottom:20px;">
                    <button onclick="openProductModal()" class="btn-primary">
                        <i data-lucide="plus" style="vertical-align:middle; width:16px;"></i> Initiate New Product
                    </button>
                </div>
                <div class="cellulose-card full-width">
                    <span class="card-label">Product Matrix</span>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Img</th>
                                <th>Designation</th>
                                <th>Class</th>
                                <th>Pricing (Iron/Wash/Dry)</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="product-list-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- ADDRESS VIEW -->
            <div id="view-address" class="hidden reveal">
                <div style="display:flex; justify-content:flex-end; margin-bottom:20px;">
                    <button onclick="openAddressModal()" class="btn-primary">
                        <i data-lucide="plus" style="vertical-align:middle; width:16px;"></i> Add Sector
                    </button>
                </div>
                <div class="cellulose-card full-width">
                    <span class="card-label">Service Sectors</span>
                    <div id="address-list-container"
                        style="display:grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px;"></div>
                </div>
            </div>

            <!-- SCHEDULE VIEW -->
            <div id="view-schedule" class="hidden reveal">
                <!-- Tab Navigation -->
                <div
                    style="display:flex; gap:15px; margin-bottom:30px; border-bottom:1px solid var(--border); padding-bottom:10px;">
                    <button id="tab-pickup-today" onclick="switchScheduleTab('pickup-today')"
                        class="schedule-tab active-tab">
                        <i data-lucide="package-check" style="width:16px; vertical-align:middle;"></i>
                        TODAY'S PICKUP
                    </button>
                    <button id="tab-delivery-today" onclick="switchScheduleTab('delivery-today')" class="schedule-tab">
                        <i data-lucide="truck" style="width:16px; vertical-align:middle;"></i>
                        TODAY'S DELIVERY
                    </button>
                    <button id="tab-delivery-tomorrow" onclick="switchScheduleTab('delivery-tomorrow')"
                        class="schedule-tab">
                        <i data-lucide="calendar-clock" style="width:16px; vertical-align:middle;"></i>
                        TOMORROW'S DELIVERY
                    </button>
                </div>

                <!-- Schedule Content -->
                <div id="schedule-content-pickup-today" class="schedule-content">
                    <div class="cellulose-card full-width">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                            <span class="card-label">Today's Pickup Schedule</span>
                            <div
                                style="font-family:'JetBrains Mono'; font-size:0.8rem; color:var(--text-mono); white-space:nowrap;">
                                AREA:
                                <select id="schedule-area-filter" onchange="applyScheduleAreaFilter()"
                                    style="display:inline-block; width:auto; background:transparent; border:none; color:var(--accent); font-weight:bold; padding:0 5px; cursor:pointer;">
                                    <option value="all">ALL AREAS</option>
                                </select>
                            </div>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Date</th>
                                    <th>Phone</th>
                                    <th>Address</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Dtl</th>
                                </tr>
                            </thead>
                            <tbody id="schedule-pickup-today-body"></tbody>
                        </table>
                    </div>
                </div>

                <div id="schedule-content-delivery-today" class="schedule-content hidden">
                    <div class="cellulose-card full-width">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                            <span class="card-label">Today's Delivery Schedule</span>
                            <div
                                style="font-family:'JetBrains Mono'; font-size:0.8rem; color:var(--text-mono); white-space:nowrap;">
                                AREA:
                                <select id="schedule-delivery-today-filter" onchange="applyScheduleAreaFilter()"
                                    style="display:inline-block; width:auto; background:transparent; border:none; color:var(--accent); font-weight:bold; padding:0 5px; cursor:pointer;">
                                    <option value="all">ALL AREAS</option>
                                </select>
                            </div>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Date</th>
                                    <th>Phone</th>
                                    <th>Address</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Dtl</th>
                                </tr>
                            </thead>
                            <tbody id="schedule-delivery-today-body"></tbody>
                        </table>
                    </div>
                </div>

                <div id="schedule-content-delivery-tomorrow" class="schedule-content hidden">
                    <div class="cellulose-card full-width">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                            <span class="card-label">Tomorrow's Delivery Schedule</span>
                            <div
                                style="font-family:'JetBrains Mono'; font-size:0.8rem; color:var(--text-mono); white-space:nowrap;">
                                AREA:
                                <select id="schedule-delivery-tomorrow-filter" onchange="applyScheduleAreaFilter()"
                                    style="display:inline-block; width:auto; background:transparent; border:none; color:var(--accent); font-weight:bold; padding:0 5px; cursor:pointer;">
                                    <option value="all">ALL AREAS</option>
                                </select>
                            </div>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Date</th>
                                    <th>Phone</th>
                                    <th>Address</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Dtl</th>
                                </tr>
                            </thead>
                            <tbody id="schedule-delivery-tomorrow-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- SUPPORT CHATS VIEW -->
            <div id="view-support" class="hidden reveal">
                <div class="cellulose-card full-width">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <span class="card-label">Support Messages</span>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Last Message</th>
                                <th>Time</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="support-chats-body"></tbody>
                    </table>
                </div>
            </div>

        </main>
    </div> <!-- End App Content -->>

    <!-- MODALS -->

    <!-- Product Modal -->
    <div id="product-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3 id="prod-modal-title" class="card-label"
                style="font-size:1rem; border-bottom:1px solid var(--border); padding-bottom:15px; margin-bottom:20px;">
                Product Configuration</h3>
            <form id="product-form" onsubmit="handleProductSubmit(event)">
                <div style="margin-bottom:15px;">
                    <label>Designation Name</label>
                    <input type="text" id="prod-name" required placeholder="e.g. T-Shirt (Cotton)">
                </div>
                <div style="margin-bottom:15px;">
                    <label>Class</label>
                    <select id="prod-cat">
                        <option value="Men">Men</option>
                        <option value="Women">Women</option>
                    </select>
                </div>
                <div style="margin-bottom:15px;">
                    <label>Description</label>
                    <input type="text" id="prod-desc" placeholder="e.g. Premium Care, Button-downs, etc.">
                </div>
                <div style="margin-bottom:15px;">
                    <label>Schematic URL</label>
                    <input type="text" id="prod-img" required placeholder="https://...">
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:20px;">
                    <div><label>Iron Cost</label><input type="number" id="prod-p-iron"></div>
                    <div><label>Wash Cost</label><input type="number" id="prod-p-wash"></div>
                    <div><label>Dry Cost</label><input type="number" id="prod-p-dry"></div>
                </div>
                <div style="display:flex; gap:10px; justify-content:flex-end;">
                    <button type="button" onclick="closeProductModal()" class="btn-secondary">Abort</button>
                    <button type="submit" class="btn-primary">Execute</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Address Modal -->
    <div id="address-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3 class="card-label"
                style="font-size:1rem; border-bottom:1px solid var(--border); padding-bottom:15px; margin-bottom:20px;">
                New Sector</h3>
            <form id="address-form" onsubmit="handleAddressSubmit(event)">
                <div style="margin-bottom:20px;">
                    <label>Sector Name</label>
                    <input type="text" id="new-service-area" required placeholder="e.g. District 9">
                </div>
                <div style="display:flex; gap:10px; justify-content:flex-end;">
                    <button type="button" onclick="closeAddressModal()" class="btn-secondary">Abort</button>
                    <button type="submit" class="btn-primary">Execute</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Order Detail Modal -->
    <div id="order-modal" class="modal-backdrop">
        <div class="modal-content" style="max-width: 500px;">
            <h3 class="card-label"
                style="font-size:1rem; border-bottom:1px solid var(--border); padding-bottom:15px; margin-bottom:20px;">
                ORDER DETAILS
            </h3>
            <div id="order-id-display"
                style="font-family:'JetBrains Mono'; color:var(--text-mono); font-size:0.75rem; margin-bottom:20px;">
            </div>
            <div id="order-detail-content">
                <!-- Content injected via JS -->
            </div>
        </div>
    </div>

    <!-- Floating Action Bar -->
    <div id="batch-fab" class="fab-container">
        <div id="fab-count" class="fab-counter">0 SELECTED</div>
        <button onclick="exitSelectionMode()" class="btn-secondary"
            style="border-radius: 20px; padding: 8px 20px; font-size: 0.8rem;">CANCEL</button>
        <button onclick="promptDeleteConfirmation()" class="btn-primary"
            style="background: var(--color-danger); color: white; border-radius: 20px; padding: 8px 20px; font-size: 0.8rem; box-shadow: none;">DELETE</button>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="confirm-modal" class="modal-backdrop">
        <div class="modal-content" style="max-width: 400px; text-align: center; border: 1px solid var(--color-danger);">
            <div style="margin-bottom: 20px;">
                <i data-lucide="alert-triangle" style="color: var(--color-danger); width: 48px; height: 48px;"></i>
            </div>
            <h3
                style="font-family:'JetBrains Mono'; color: var(--text-main); margin-bottom: 15px; text-transform: uppercase;">
                Confirm Deletion</h3>
            <p style="color: var(--text-mono); font-size: 0.9rem; margin-bottom: 30px; line-height: 1.5;">
                You are about to permanently remove <span id="confirm-count"
                    style="color: #fff; font-weight: bold;">0</span> items.<br>
                <span id="confirm-warning"
                    style="color: var(--color-danger); font-size: 0.8rem; display: block; margin-top: 10px;"></span>
            </p>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button onclick="closeConfirmModal()" class="btn-secondary">Cancel</button>
                <button onclick="executeBatchDelete()" class="btn-primary"
                    style="background: var(--color-danger); color: white;">CONFIRM DELETE</button>
            </div>
        </div>
    </div>

    <!-- Chat Detail Modal -->
    <div id="chat-detail-modal" class="modal-backdrop">
        <div class="modal-content" style="max-width: 600px; max-height: 80vh; display: flex; flex-direction: column;">
            <div
                style="display:flex; justify-content:space-between; align-items:center; border-bottom: 1px solid var(--border); padding-bottom: 15px; margin-bottom: 20px;">
                <div>
                    <h3 class="card-label" style="margin:0;">Support Chat</h3>
                    <div id="chat-user-info"
                        style="font-family:'JetBrains Mono'; font-size:0.75rem; color:var(--text-mono); margin-top:5px;">
                    </div>
                </div>
                <button onclick="closeChatDetail()"
                    style="background:none; border:none; cursor:pointer; color:var(--text-mono); font-size:1.5rem;">&times;</button>
            </div>

            <div id="admin-chat-messages"
                style="flex:1; overflow-y:auto; max-height: 400px; margin-bottom: 20px; padding-right: 10px;">
                <!-- Messages will be injected here -->
            </div>

            <div style="display:flex; gap:10px; border-top:1px solid var(--border); padding-top:15px;">
                <input type="text" id="admin-chat-input" placeholder="Type your reply..." style="flex:1;">
                <button onclick="adminChat.sendReply()" class="btn-primary">
                    <i data-lucide="send" style="width:16px; vertical-align:middle;"></i> Send
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // --- Init Lucide Icons ---
        lucide.createIcons();

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyD_whg2YD3iBAYfxpqZwYpdURrg8eyPgwg",
            authDomain: "business-project-910f2.firebaseapp.com",
            databaseURL: "https://business-project-910f2-default-rtdb.firebaseio.com",
            projectId: "business-project-910f2",
            storageBucket: "business-project-910f2.firebasestorage.app",
            messagingSenderId: "52172689456",
            appId: "1:52172689456:web:92eaf5189d9288b2c85df5"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- State ---
        let ordersData = [];
        let usersData = [];
        let productsData = [];
        let addressesData = [];
        let editingProductKey = null;

        // --- Batch Delete State ---
        let isSelectionMode = false;
        let selectedIds = new Set();
        let currentSelectionType = null; // 'orders', 'users', 'products', 'address', 'support'
        let longPressTimer;

        // --- Batch Delete Logic ---

        function initLongPress(element, type, id) {
            element.addEventListener('mousedown', () => startLongPress(type, id));
            element.addEventListener('touchstart', () => startLongPress(type, id), { passive: true });

            element.addEventListener('mouseup', cancelLongPress);
            element.addEventListener('mouseleave', cancelLongPress);
            element.addEventListener('touchend', cancelLongPress);

            // Click handler to toggle if in selection mode
            element.addEventListener('click', (e) => {
                if (isSelectionMode) {
                    e.preventDefault();
                    e.stopPropagation(); // Stop navigation
                    toggleSelection(id, type);
                }
            });
        }

        function startLongPress(type, id) {
            if (isSelectionMode) return; // Already selecting
            longPressTimer = setTimeout(() => {
                enterSelectionMode(type, id);
            }, 800); // 800ms for long press (User asked for 3s but that's very long for UX, sticking to 800ms is standard, maybe user meant 'long press') - actually User said "3sec", I should probably stick to 3000ms if they were specific, or maybe 1500ms. I'll do 1500ms as a compromise between "3sec" and usability.
            // Wait, user explicitly said "click on 3sec". I'll do 2000ms to be safe and close to their request without being annoying.
        }

        function cancelLongPress() {
            clearTimeout(longPressTimer);
        }

        function enterSelectionMode(type, initialId) {
            isSelectionMode = true;
            currentSelectionType = type;
            selectedIds.clear();
            selectedIds.add(initialId); // Select the item we long-pressed

            document.body.classList.add('selection-mode');
            document.getElementById('batch-fab').classList.add('fab-active');

            updateSelectionUI();
            refreshCurrentView(); // Re-render to show checkboxes

            // Vibrate if mobile
            if (navigator.vibrate) navigator.vibrate(50);
        }

        function exitSelectionMode() {
            isSelectionMode = false;
            selectedIds.clear();
            currentSelectionType = null;

            document.body.classList.remove('selection-mode');
            document.getElementById('batch-fab').classList.remove('fab-active');

            refreshCurrentView();
        }

        function toggleSelection(id, type) {
            if (currentSelectionType !== type) return; // Prevent mixing types

            if (selectedIds.has(id)) {
                selectedIds.delete(id);
                if (selectedIds.size === 0) exitSelectionMode(); // Auto-exit if empty
            } else {
                selectedIds.add(id);
            }
            updateSelectionUI();
            refreshCurrentView();
        }

        function updateSelectionUI() {
            document.getElementById('fab-count').innerText = selectedIds.size + " SELECTED";
        }

        function refreshCurrentView() {
            // Re-call the render function for the current view
            // We can infer view from currentSelectionType (mostly)
            if (currentSelectionType === 'orders') {
                updateUI(); // This calls renderOrders logic
            } else if (currentSelectionType === 'users') {
                renderUsers();
            } else if (currentSelectionType === 'products') {
                renderProducts();
            } else if (currentSelectionType === 'address') {
                renderAddresses();
            } else if (currentSelectionType === 'support') {
                adminChat.renderChatList();
            }
        }

        // --- Delete Workflow ---

        function promptDeleteConfirmation() {
            if (selectedIds.size === 0) return;

            document.getElementById('confirm-count').innerText = selectedIds.size;
            const warningEl = document.getElementById('confirm-warning');

            if (currentSelectionType === 'users') {
                warningEl.innerText = "WARNING: Deleting users will also delete all their linked Orders and Addresses.";
            } else {
                warningEl.innerText = "This action cannot be undone.";
            }

            document.getElementById('confirm-modal').classList.add('modal-active');
        }

        function closeConfirmModal() {
            document.getElementById('confirm-modal').classList.remove('modal-active');
        }

        async function executeBatchDelete() {
            const ids = Array.from(selectedIds);
            const updates = {};

            // Build updates object for atomic(ish) delete
            ids.forEach(id => {
                if (currentSelectionType === 'orders') {
                    updates['orders/' + id] = null;
                } else if (currentSelectionType === 'products') {
                    // product id is the dbKey
                    updates['products/' + id] = null;
                } else if (currentSelectionType === 'address') {
                    // address data structure is array or object? 
                    // In fetchData logic: addressesData = Object.values(data) OR array.
                    // Wait, db structure for addresses was: db.ref('serviceAreas').push(val);
                    // So it's a list pushed with keys. addressesData needs to keep keys to delete.
                    // I need to check renderAddresses to see if we have keys.
                    // Currently renderAddresses uses `addressesData.map` which might not have keys if I didn't map them.
                    // I need to fix fetchData for addresses first to ensure we have keys.
                    updates['serviceAreas/' + id] = null;
                } else if (currentSelectionType === 'users') {
                    updates['users/' + id] = null;
                    // Cascade: Find items with userId == id
                    // Orders
                    ordersData.filter(o => o.userId === id).forEach(o => {
                        updates['orders/' + o.id] = null;
                    });
                    // Addresses?
                    // The address logic in 'serviceAreas' seems global, unrelated to user?
                    // Admin.html:1014 db.ref('serviceAreas').push(val); 
                    // This creates a global list of service areas. It's not user-specific addresses in that node.
                    // User specific addresses are on the user object: u.address. So deleting user deletes that.
                } else if (currentSelectionType === 'support') {
                    updates['users/' + id + '/supportChat'] = null;
                }
            });

            try {
                await db.ref().update(updates);
                closeConfirmModal();
                exitSelectionMode();
            } catch (e) {
                console.error("Delete failed", e);
                alert("Delete failed: " + e.message);
            }
        }

        // --- Charts ---
        let revenueChart, volumeChart;

        function initCharts() {
            const ctx1 = document.getElementById('miniRevenueChart').getContext('2d');
            const ctx2 = document.getElementById('miniVolumeChart').getContext('2d');

            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: false },
                    y: { display: false }
                },
                elements: {
                    line: { tension: 0.4, borderWidth: 2 },
                    point: { radius: 0 }
                }
            };

            revenueChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: ['M', 'T', 'W', 'T', 'F', 'S', 'S'],
                    datasets: [{
                        data: [10, 25, 15, 30, 45, 20, 40],
                        borderColor: '#00f2ff',
                        backgroundColor: 'rgba(0, 242, 255, 0.1)',
                        fill: true
                    }]
                },
                options: commonOptions
            });

            volumeChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['M', 'T', 'W', 'T', 'F', 'S', 'S'],
                    datasets: [{
                        data: [12, 19, 8, 15, 22, 10, 18],
                        backgroundColor: 'rgba(255, 255, 255, 0.1)',
                        hoverBackgroundColor: '#00f2ff'
                    }]
                },
                options: commonOptions
            });
        }

        // --- Data Fetching ---
        function fetchData() {
            db.ref('orders').on('value', snapshot => {
                const data = snapshot.val();
                ordersData = data ? Object.keys(data).map(k => ({ id: k, ...data[k] })) : [];
                ordersData.sort((a, b) => new Date(b.date) - new Date(a.date));
                updateUI();
            });

            db.ref('users').on('value', snapshot => {
                const data = snapshot.val();
                usersData = data ? Object.keys(data).map(k => ({ id: k, ...data[k] })) : [];
                updateUI();
            });

            db.ref('products').on('value', snapshot => {
                const data = snapshot.val();
                if (data) {
                    productsData = Array.isArray(data)
                        ? data.map((p, i) => ({ ...p, dbKey: i }))
                        : Object.keys(data).map(k => ({ dbKey: k, ...data[k] }));
                } else {
                    productsData = [];
                }
                renderProducts();
            });

            db.ref('serviceAreas').on('value', snapshot => {
                const data = snapshot.val();
                if (data) {
                    // Map keys for deletion. Support both object (pushed keys) and array (legacy)
                    addressesData = Object.keys(data).map(k => {
                        const val = data[k];
                        return { id: k, name: (typeof val === 'object' ? val.name : val) };
                    });
                } else {
                    addressesData = [];
                }
                renderAddresses();
            });
        }

        function updateUI() {
            // Stats
            const revenue = ordersData.reduce((acc, o) => acc + (parseFloat((o.total || "0").replace(/[^\d.]/g, '')) || 0), 0);
            const pending = ordersData.filter(o => o.status && (o.status.toLowerCase().includes('pick') || o.status.toLowerCase().includes('pending'))).length;

            document.getElementById('stat-revenue').innerText = '₹' + revenue.toLocaleString();
            document.getElementById('stat-users').innerText = usersData.length;
            document.getElementById('stat-pending').innerText = pending;

            // Dashboard Table
            const recent = ordersData.slice(0, 5);
            document.getElementById('dashboard-txns').innerHTML = recent.map(o => renderRow(o, false)).join('');

            // Full Orders Table
            let filteredOrders = ordersData;
            if (window.currentFilter === 'pickup') {
                filteredOrders = ordersData.filter(o => {
                    const s = (o.status || '').toLowerCase();
                    return !s || s.includes('pick') || s.includes('pending');
                });
            }
            document.getElementById('orders-table-body').innerHTML = filteredOrders.map(o => renderRow(o, true)).join('');

            // Users Table
            renderUsers();

            // Schedule View - auto-update if currently viewing schedule
            const scheduleView = document.getElementById('view-schedule');
            if (scheduleView && !scheduleView.classList.contains('hidden')) {
                renderScheduleView();
            }
            // Update Support Chat List (if loaded) to ensure user names/phones are fresh
            // Update Support Chat List
            if (typeof adminChat !== 'undefined') {
                adminChat.updateFromUsers(usersData);
            }
        }

        // --- Filter Logic ---
        window.currentFilter = 'all';
        window.currentSearchQuery = '';
        window.currentScheduleAreaFilter = 'all';

        function applyOrderFilters() {
            // Get current filter and search values
            const filterSelect = document.getElementById('order-filter');
            const searchInput = document.getElementById('order-search');

            window.currentFilter = filterSelect ? filterSelect.value : 'all';
            window.currentSearchQuery = searchInput ? searchInput.value.toLowerCase().trim() : '';

            // Apply filters
            let filteredOrders = ordersData;

            // Apply status filter first
            if (window.currentFilter !== 'all') {
                filteredOrders = ordersData.filter(o => {
                    const status = (o.status || '').toLowerCase();

                    switch (window.currentFilter) {
                        case 'pick-later':
                            // Orders pending pickup (empty status, 'pick', 'pending', or 'pick up in')
                            return status === '' || status.includes('pick') || status.includes('pending');
                        case 'delivery-later':
                            // Orders with "Delivery in 4-5 Days" status
                            return status.includes('delivery in');
                        case 'aborted':
                            // Cancelled orders
                            return status.includes('cancel') || status.includes('abort');
                        default:
                            return true;
                    }
                });
            }

            // Apply search filter on top of status filter
            if (window.currentSearchQuery) {
                filteredOrders = filteredOrders.filter(o => {
                    const orderId = (o.id || '').toLowerCase();
                    return orderId.includes(window.currentSearchQuery);
                });
            }

            // Render filtered results
            const tbody = document.getElementById('orders-table-body');
            if (tbody) {
                if (filteredOrders.length > 0) {
                    tbody.innerHTML = filteredOrders.map(o => renderRow(o, true)).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; color:var(--text-mono); padding:30px;">No orders found matching your criteria</td></tr>';
                }
                lucide.createIcons();
            }
        }

        // Legacy function for compatibility
        function applyFilter(val) {
            window.currentFilter = val;
            applyOrderFilters();
        }

        // Schedule Area Filter Function
        function applyScheduleAreaFilter() {
            const filterSelect = document.getElementById('schedule-area-filter');
            window.currentScheduleAreaFilter = filterSelect ? filterSelect.value : 'all';

            // Re-render schedule view to apply filter
            renderScheduleView();
        }

        function renderRow(txn, showActions) {
            let statusClass = 'status-tag ';
            const s = (txn.status || 'Pick up in 3hr').toLowerCase();

            // Color Logic
            if (s === 'delivered' || s.includes('complete')) statusClass += 'status-success';
            else if (s.includes('cancel') || s.includes('abort')) statusClass += 'status-danger';
            else statusClass += 'status-warning';

            // Display Text
            const displayStatus = txn.status || 'Pick up in 3hr';

            // Sync Address
            let address = txn.address;
            if (!address && txn.userId) {
                const user = usersData.find(u => u.id === txn.userId);
                if (user) address = user.address;
            }
            address = address || 'N/A';

            // Calculate items
            let itemCount = 0;
            if (txn.bags) txn.bags.forEach(b => {
                if (b.items) b.items.forEach(i => itemCount += (i.qty || 1));
            });

            // Format date
            let dateDisplay = 'N/A';
            if (txn.date) {
                const orderDate = new Date(txn.date);
                dateDisplay = orderDate.toLocaleDateString('en-IN', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });
            }

            const actionSelect = `
                <div style="display:flex; gap:5px; align-items:center;">
                     <select onchange="handleStatusChange(this, '${txn.id}')" onclick="event.stopPropagation()" style="padding:5px; font-size:0.75rem; width:auto; border-radius:4px;">
                        <option value="" disabled selected>CMD</option>
                        <option value="pickup">INIT_PICKUP</option>
                        <option value="delivered">CONFIRM_DELIVERY</option>
                        <option value="cancel">ABORT</option>
                    </select>
                </div>
            `;

            const detailButton = `
                <button onclick="event.stopPropagation(); openOrderDetail('${txn.id}')" class="btn-secondary" style="padding:5px 10px; font-size:0.7rem;">
                    <i data-lucide="eye" style="width:12px; vertical-align:middle;"></i> DTL
                </button>
            `;

            // Selection Logic
            const isSelected = selectedIds.has(txn.id);
            const rowClass = (isSelectionMode && isSelected) ? 'row-selected' : '';
            const checkbox = `<div class="select-checkbox ${isSelected ? 'checked' : ''}"></div>`;

            const longPressEvents = `
                onmousedown="startLongPress('orders', '${txn.id}')"
                ontouchstart="startLongPress('orders', '${txn.id}')" 
                onmouseup="cancelLongPress()" 
                onmouseleave="cancelLongPress()"
                ontouchend="cancelLongPress()"
                onclick="if(isSelectionMode) { event.stopPropagation(); toggleSelection('${txn.id}', 'orders'); }"
            `;

            return `
                <tr class="${rowClass}" ${longPressEvents} style="transition:background 0.2s; cursor: pointer;">
                    <td style="font-family:'JetBrains Mono'; color:var(--accent);">
                        ${checkbox}
                        #${txn.id.substring(1)}
                    </td>
                    <td><span style="font-weight:700;">${txn.userName || 'Unknown'}</span></td>
                    <td style="font-family:'JetBrains Mono'; font-size:0.75rem; color:var(--text-mono);">${dateDisplay}</td>
                    <td>${itemCount} Items</td>
                    ${showActions ? `<td style="font-size:0.75rem; color:var(--text-mono); max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${address}</td>` : ''}
                    <td>${txn.total || 0}</td>
                    <td><span class="${statusClass}">${displayStatus}</span></td>
                    ${showActions ? `<td>${actionSelect}</td>` : ''}
                    ${showActions ? `<td>${detailButton}</td>` : ''}
                </tr>
            `;
        }

        function renderUsers() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = usersData.map(u => {
                const ava = `https://ui-avatars.com/api/?name=${encodeURIComponent(u.name)}&background=random&color=fff`;
                const ltv = ordersData.filter(o => o.userId === u.id).reduce((acc, o) => acc + (parseFloat((o.total || "0").replace(/[^\d.]/g, '')) || 0), 0);

                // Selection Logic
                const isSelected = selectedIds.has(u.id);
                const rowClass = (isSelectionMode && isSelected) ? 'row-selected' : '';
                const checkbox = `<div class="select-checkbox ${isSelected ? 'checked' : ''}" style="margin-right:10px; vertical-align:middle;"></div>`;

                const longPressEvents = `
                    onmousedown="startLongPress('users', '${u.id}')"
                    ontouchstart="startLongPress('users', '${u.id}')" 
                    onmouseup="cancelLongPress()" 
                    onmouseleave="cancelLongPress()"
                    ontouchend="cancelLongPress()"
                    onclick="if(isSelectionMode) { event.stopPropagation(); toggleSelection('${u.id}', 'users'); }"
                `;

                return `
                    <tr class="${rowClass}" ${longPressEvents} style="transition:background 0.2s; cursor:pointer;">
                        <td style="display:flex; align-items:center;">
                            ${checkbox}
                            <img src="${ava}" alt="av">
                        </td>
                        <td>
                            <div style="font-weight:700;">${u.name}</div>
                            <div style="color:var(--text-mono); font-size:0.75rem;">${u.email || 'NO_AUTH_ID'}</div>
                        </td>
                        <td>${u.phone}</td>
                        <td style="font-size:0.75rem; color:var(--text-mono);">${u.address || 'N/A'}</td>
                        <td style="color:var(--color-success);">₹${ltv.toLocaleString()}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderProducts() {
            const tbody = document.getElementById('product-list-body');
            tbody.innerHTML = productsData.map(p => {
                // Selection Logic
                const isSelected = selectedIds.has(p.dbKey);
                const rowClass = (isSelectionMode && isSelected) ? 'row-selected' : '';
                const checkbox = `<div class="select-checkbox ${isSelected ? 'checked' : ''}" style="margin-right:10px; vertical-align:middle;"></div>`;

                const longPressEvents = `
                    onmousedown="startLongPress('products', '${p.dbKey}')"
                    ontouchstart="startLongPress('products', '${p.dbKey}')" 
                    onmouseup="cancelLongPress()" 
                    onmouseleave="cancelLongPress()"
                    ontouchend="cancelLongPress()"
                    onclick="if(isSelectionMode) { event.stopPropagation(); toggleSelection('${p.dbKey}', 'products'); }"
                `;

                return `
                <tr class="${rowClass}" ${longPressEvents} style="transition:background 0.2s; cursor:pointer;">
                    <td style="display:flex; align-items:center;">
                        ${checkbox}
                        <img src="${p.img}" style="width:40px; height:40px; border-radius:4px; object-fit:cover; border:1px solid var(--border);">
                    </td>
                    <td><span style="font-weight:700; color:var(--text-main);">${p.name}</span></td>
                    <td style="color:var(--text-mono);">${p.cat}</td>
                    <td style="font-family:'JetBrains Mono'; font-size:0.75rem; color:var(--accent);">
                        ₹${p.prices?.iron || 0} / ₹${p.prices?.wash || 0} / ₹${p.prices?.dry || 0}
                    </td>
                    <td>
                        <button onclick="event.stopPropagation(); editProduct('${p.dbKey}')" class="btn-secondary" style="padding:5px 10px; font-size:0.7rem;">
                            <i data-lucide="edit-2" style="width:12px; vertical-align:middle;"></i> EDIT
                        </button>
                    </td>
                </tr>
            `;
            }).join('');
            lucide.createIcons();
        }

        function renderAddresses() {
            const container = document.getElementById('address-list-container');
            container.innerHTML = addressesData.map(a => {
                // Selection Logic
                const isSelected = selectedIds.has(a.id);
                const isActive = (isSelectionMode && isSelected);
                const bg = isActive ? 'rgba(0, 242, 255, 0.1)' : 'rgba(255,255,255,0.02)';
                const border = isActive ? 'var(--accent)' : 'var(--border)';
                const checkbox = `<div class="select-checkbox ${isSelected ? 'checked' : ''}" style="margin-right:10px;"></div>`;

                const longPressEvents = `
                    onmousedown="startLongPress('address', '${a.id}')"
                    ontouchstart="startLongPress('address', '${a.id}')" 
                    onmouseup="cancelLongPress()" 
                    onmouseleave="cancelLongPress()"
                    ontouchend="cancelLongPress()"
                    onclick="if(isSelectionMode) { event.stopPropagation(); toggleSelection('${a.id}', 'address'); }"
                `;

                return `
                <div ${longPressEvents} style="padding:15px; border:1px solid ${border}; background:${bg}; display:flex; align-items:center; gap:10px; cursor:pointer; transition:all 0.2s;">
                    ${checkbox}
                    <i data-lucide="map-pin" style="color:var(--accent); width:16px;"></i>
                    <span style="font-family:'JetBrains Mono'; font-size:0.9rem;">${a.name || 'Unknown'}</span>
                </div>
            `;
            }).join('');
            lucide.createIcons();
        }

        // --- Actions ---
        function handleStatusChange(el, id) {
            const val = el.value;
            let stat = '';
            if (val === 'pickup') stat = 'Delivery in 4-5 Days';
            else if (val === 'delivered') stat = 'Delivered';
            else if (val === 'cancel') stat = 'Cancelled';

            if (stat) {
                db.ref('orders/' + id).update({ status: stat });
                el.value = "";
            }
        }

        function handleProductSubmit(e) {
            e.preventDefault();
            const p = {
                name: document.getElementById('prod-name').value,
                cat: document.getElementById('prod-cat').value,
                description: document.getElementById('prod-desc').value || 'Premium Care',
                img: document.getElementById('prod-img').value,
                prices: {
                    iron: parseInt(document.getElementById('prod-p-iron').value) || 0,
                    wash: parseInt(document.getElementById('prod-p-wash').value) || 0,
                    dry: parseInt(document.getElementById('prod-p-dry').value) || 0
                }
            };

            if (editingProductKey !== null) {
                db.ref('products/' + editingProductKey).update(p);
            } else {
                db.ref('products').push(p);
            }
            closeProductModal();
        }

        function handleAddressSubmit(e) {
            e.preventDefault();
            const val = document.getElementById('new-service-area').value.trim();
            if (!val) return;
            db.ref('serviceAreas').push(val);
            closeAddressModal();
        }

        // --- Navigation & Modals ---
        function navigate(view) {
            // Update Headers
            const titles = {
                'dashboard': 'Core Architecture',
                'all_orders': 'Order Registry',
                'users': 'User Database',
                'add_product': 'Product Matrix',
                'add_address': 'Sector Map',
                'schedule': 'Schedule Management',
                'support': 'Support Messages'
            };
            document.getElementById('page-title').innerText = titles[view] || 'Unknown Node';

            // Toggle Views
            ['view-dashboard', 'view-orders', 'view-users', 'view-products', 'view-address', 'view-schedule', 'view-support'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });

            const map = {
                'dashboard': 'view-dashboard',
                'all_orders': 'view-orders',
                'users': 'view-users',
                'add_product': 'view-products',
                'add_address': 'view-address',
                'schedule': 'view-schedule',
                'support': 'view-support'
            };
            document.getElementById(map[view]).classList.remove('hidden');

            // If navigating to schedule, render it
            if (view === 'schedule') {
                renderScheduleView();
            }

            // Active State
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            // Mapping Logic for nav items (simple index based or logic)
            // For now, we just rely on click adding active to "this" if we passed event, but we didn't. 
            // Let's re-query based on onclick attribute matching used in HTML
            // Optimization: Just simple loop
        }

        // --- Schedule View Functions ---
        function switchScheduleTab(tab) {
            // Remove active class from all tabs
            document.querySelectorAll('.schedule-tab').forEach(t => t.classList.remove('active-tab'));

            // Hide all schedule content sections
            document.querySelectorAll('.schedule-content').forEach(c => c.classList.add('hidden'));

            // Activate selected tab
            document.getElementById(`tab-${tab}`).classList.add('active-tab');
            document.getElementById(`schedule-content-${tab}`).classList.remove('hidden');

            // Re-render icons
            lucide.createIcons();
        }

        function renderScheduleView() {
            const now = new Date();
            const currentHour = now.getHours();

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            // Helper function to get pickup timestamp
            // This checks for pickupTime field, or falls back to date if status changed to delivery
            function getPickupTimestamp(order) {
                // If order has explicit pickupTime field, use it
                if (order.pickupTime) {
                    return new Date(order.pickupTime).getTime();
                }

                // If order has pickupDate field, use it
                if (order.pickupDate) {
                    return new Date(order.pickupDate).getTime();
                }

                // Fallback: if status is "Delivery in 4-5 Days", estimate pickup was when order was placed
                const status = (order.status || '').toLowerCase();
                if (status.includes('delivery') && order.date) {
                    return new Date(order.date).getTime();
                }

                return null;
            }

            // Filter orders for today's pickup (orders placed today and pending pickup)
            let pickupToday = ordersData.filter(o => {
                const orderDate = o.date ? new Date(o.date) : null;
                if (!orderDate) return false;
                orderDate.setHours(0, 0, 0, 0);

                const status = (o.status || '').toLowerCase();
                const isPickupStatus = status.includes('pick') || status.includes('pending') || status === '';

                return orderDate.getTime() === today.getTime() && isPickupStatus;
            });

            // Apply service area filter to pickup orders
            if (window.currentScheduleAreaFilter && window.currentScheduleAreaFilter !== 'all') {
                pickupToday = pickupToday.filter(o => {
                    // Get address from order or user
                    let address = o.address;
                    if (!address && o.userId) {
                        const user = usersData.find(u => u.id === o.userId);
                        if (user) address = user.address;
                    }

                    // Match address with selected area (case-insensitive partial match)
                    if (address) {
                        return address.toLowerCase().includes(window.currentScheduleAreaFilter.toLowerCase());
                    }
                    return false;
                });
            }

            // Populate service area dropdown with counts
            const areaFilterSelect = document.getElementById('schedule-area-filter');
            if (areaFilterSelect) {
                const currentValue = areaFilterSelect.value;

                // Get all orders before area filter is applied (to count correctly)
                const allPickupToday = ordersData.filter(o => {
                    const orderDate = o.date ? new Date(o.date) : null;
                    if (!orderDate) return false;
                    orderDate.setHours(0, 0, 0, 0);
                    const status = (o.status || '').toLowerCase();
                    const isPickupStatus = status.includes('pick') || status.includes('pending') || status === '';
                    return orderDate.getTime() === today.getTime() && isPickupStatus;
                });

                // Helper function to get address
                const getOrderAddress = (o) => {
                    let address = o.address;
                    if (!address && o.userId) {
                        const user = usersData.find(u => u.id === o.userId);
                        if (user) address = user.address;
                    }
                    return address;
                };

                // Calculate total count
                const totalCount = allPickupToday.length;
                areaFilterSelect.innerHTML = `<option value="all">ALL AREAS (${totalCount})</option>`;

                // Calculate count for each area
                addressesData.forEach(area => {
                    const count = allPickupToday.filter(o => {
                        const address = getOrderAddress(o);
                        return address && address.toLowerCase().includes(area.name.toLowerCase());
                    }).length;

                    const option = document.createElement('option');
                    option.value = area.name;
                    option.textContent = `${area.name} (${count})`;
                    areaFilterSelect.appendChild(option);
                });

                // Restore selected value
                areaFilterSelect.value = currentValue;
            }

            // Filter orders for today's delivery (96 hours from pickup)
            let deliveryToday = ordersData.filter(o => {
                const pickupTimestamp = getPickupTimestamp(o);
                if (!pickupTimestamp) return false;

                const hoursSincePickup = (now.getTime() - pickupTimestamp) / (1000 * 60 * 60);

                // Order should be picked up 96 hours ago (4 days)
                // Allow some buffer: 90-102 hours
                const isReadyForDelivery = hoursSincePickup >= 90 && hoursSincePickup <= 102;

                // Apply 12 PM cutoff: if it's after noon and the order is in the early window,
                // skip it (add 5-6 hour buffer means if it's too close to cutoff, skip for today)
                if (currentHour >= 12) {
                    // If the order just became eligible (90-96 hours), skip it for today
                    if (hoursSincePickup >= 90 && hoursSincePickup < 96) {
                        return false;
                    }
                }

                return isReadyForDelivery;
            });

            // Populate today's delivery dropdown with counts
            const deliveryTodayFilter = document.getElementById('schedule-delivery-today-filter');
            if (deliveryTodayFilter) {
                const currentValue = deliveryTodayFilter.value;
                const getOrderAddress = (o) => {
                    let address = o.address;
                    if (!address && o.userId) {
                        const user = usersData.find(u => u.id === o.userId);
                        if (user) address = user.address;
                    }
                    return address;
                };

                const totalCount = deliveryToday.length;
                deliveryTodayFilter.innerHTML = `<option value="all">ALL AREAS (${totalCount})</option>`;

                addressesData.forEach(area => {
                    const count = deliveryToday.filter(o => {
                        const address = getOrderAddress(o);
                        return address && address.toLowerCase().includes(area.name.toLowerCase());
                    }).length;

                    const option = document.createElement('option');
                    option.value = area.name;
                    option.textContent = `${area.name} (${count})`;
                    deliveryTodayFilter.appendChild(option);
                });

                deliveryTodayFilter.value = currentValue;

                // Apply area filter to delivery today
                if (currentValue && currentValue !== 'all') {
                    deliveryToday = deliveryToday.filter(o => {
                        const address = getOrderAddress(o);
                        return address && address.toLowerCase().includes(currentValue.toLowerCase());
                    });
                }
            }

            // Filter orders for tomorrow's delivery (120 hours from pickup)
            let deliveryTomorrow = ordersData.filter(o => {
                const pickupTimestamp = getPickupTimestamp(o);
                if (!pickupTimestamp) return false;

                const hoursSincePickup = (now.getTime() - pickupTimestamp) / (1000 * 60 * 60);

                // Order should be picked up 120 hours ago (5 days)
                // Allow buffer: 114-126 hours
                const isReadyForTomorrow = hoursSincePickup >= 114 && hoursSincePickup <= 126;

                // No 12 PM cutoff for tomorrow's deliveries - show all eligible orders
                return isReadyForTomorrow;
            });

            // Populate tomorrow's delivery dropdown with counts
            const deliveryTomorrowFilter = document.getElementById('schedule-delivery-tomorrow-filter');
            if (deliveryTomorrowFilter) {
                const currentValue = deliveryTomorrowFilter.value;
                const getOrderAddress = (o) => {
                    let address = o.address;
                    if (!address && o.userId) {
                        const user = usersData.find(u => u.id === o.userId);
                        if (user) address = user.address;
                    }
                    return address;
                };

                const totalCount = deliveryTomorrow.length;
                deliveryTomorrowFilter.innerHTML = `<option value="all">ALL AREAS (${totalCount})</option>`;

                addressesData.forEach(area => {
                    const count = deliveryTomorrow.filter(o => {
                        const address = getOrderAddress(o);
                        return address && address.toLowerCase().includes(area.name.toLowerCase());
                    }).length;

                    const option = document.createElement('option');
                    option.value = area.name;
                    option.textContent = `${area.name} (${count})`;
                    deliveryTomorrowFilter.appendChild(option);
                });

                deliveryTomorrowFilter.value = currentValue;

                // Apply area filter to delivery tomorrow
                if (currentValue && currentValue !== 'all') {
                    deliveryTomorrow = deliveryTomorrow.filter(o => {
                        const address = getOrderAddress(o);
                        return address && address.toLowerCase().includes(currentValue.toLowerCase());
                    });
                }
            }

            // Render tables
            document.getElementById('schedule-pickup-today-body').innerHTML =
                pickupToday.length > 0
                    ? pickupToday.map(o => renderScheduleRow(o)).join('')
                    : '<tr><td colspan="9" style="text-align:center; color:var(--text-mono); padding:30px;">No pickup scheduled for today</td></tr>';

            document.getElementById('schedule-delivery-today-body').innerHTML =
                deliveryToday.length > 0
                    ? deliveryToday.map(o => renderScheduleRow(o, 'delivery-today')).join('')
                    : '<tr><td colspan="9" style="text-align:center; color:var(--text-mono); padding:30px;">No delivery scheduled for today</td></tr>';

            document.getElementById('schedule-delivery-tomorrow-body').innerHTML =
                deliveryTomorrow.length > 0
                    ? deliveryTomorrow.map(o => renderScheduleRow(o, 'delivery-tomorrow')).join('')
                    : '<tr><td colspan="9" style="text-align:center; color:var(--text-mono); padding:30px;">No delivery scheduled for tomorrow</td></tr>';

            lucide.createIcons();
        }

        function renderScheduleRow(txn, scheduleType = 'pickup') {
            // Get user info
            let phone = txn.userPhone || 'N/A';
            let address = txn.address;
            let name = txn.userName || 'Unknown';

            if (txn.userId) {
                const user = usersData.find(u => u.id === txn.userId);
                if (user) {
                    phone = user.phone || phone;
                    address = user.address || address;
                    name = user.name || name;
                }
            }
            address = address || 'N/A';

            // Format date
            let dateDisplay = 'N/A';
            if (txn.date) {
                const orderDate = new Date(txn.date);
                dateDisplay = orderDate.toLocaleDateString('en-IN', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });
            }

            // Status
            let statusClass = 'status-tag ';
            const s = (txn.status || 'Pending Pickup').toLowerCase();

            if (s === 'delivered' || s.includes('complete')) statusClass += 'status-success';
            else if (s.includes('cancel') || s.includes('abort')) statusClass += 'status-danger';
            else statusClass += 'status-warning';

            const displayStatus = txn.status || 'Pending Pickup';

            // Calculate items
            let itemCount = 0;
            if (txn.bags) txn.bags.forEach(b => {
                if (b.items) b.items.forEach(i => itemCount += (i.qty || 1));
            });

            // Calculate timing information for delivery schedules
            let timingInfo = '';
            if (scheduleType === 'delivery-today' || scheduleType === 'delivery-tomorrow') {
                let pickupTimestamp = null;
                if (txn.pickupTime) {
                    pickupTimestamp = new Date(txn.pickupTime).getTime();
                } else if (txn.pickupDate) {
                    pickupTimestamp = new Date(txn.pickupDate).getTime();
                } else if (txn.status && txn.status.toLowerCase().includes('delivery') && txn.date) {
                    pickupTimestamp = new Date(txn.date).getTime();
                }

                if (pickupTimestamp) {
                    const pickupDate = new Date(pickupTimestamp);
                    const pickupStr = pickupDate.toLocaleDateString() + ' ' + pickupDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                    // Expected delivery is based on pickup time
                    const expectedDeliveryTime = scheduleType === 'delivery-today'
                        ? new Date(pickupTimestamp + (96 * 60 * 60 * 1000)) // 96 hours
                        : new Date(pickupTimestamp + (120 * 60 * 60 * 1000)); // 120 hours

                    const deliveryStr = expectedDeliveryTime.toLocaleDateString() + ' ' + expectedDeliveryTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                    timingInfo = `
                        <div style="font-size:0.7rem; color:var(--text-mono); margin-top:3px;">
                            <div>Pickup: ${pickupStr}</div>
                            <div style="color:var(--accent);">Expected: ${deliveryStr}</div>
                        </div>
                    `;
                }
            }

            const detailButton = `
                <button onclick="openOrderDetail('${txn.id}')" class="btn-secondary" style="padding:5px 10px; font-size:0.7rem;">
                    <i data-lucide="eye" style="width:12px; vertical-align:middle;"></i> DTL
                </button>
            `;

            return `
                <tr style="transition:background 0.2s;">
                    <td style="font-family:'JetBrains Mono'; color:var(--accent);">
                        #${txn.id.substring(1)}
                        ${timingInfo}
                    </td>
                    <td><span style="font-weight:700;">${name}</span></td>
                    <td style="font-family:'JetBrains Mono'; font-size:0.75rem; color:var(--text-mono);">${dateDisplay}</td>
                    <td style="font-family:'JetBrains Mono'; font-size:0.75rem;">${phone}</td>
                    <td style="font-size:0.75rem; color:var(--text-mono); max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${address}</td>
                    <td>${itemCount} Items</td>
                    <td>${txn.total || 0}</td>
                    <td><span class="${statusClass}">${displayStatus}</span></td>
                    <td>${detailButton}</td>
                </tr>
            `;
        }

        // Nav click handler for styling
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function () {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
            });
        });

        function openProductModal() { document.getElementById('product-modal').classList.add('modal-active'); }
        function closeProductModal() { document.getElementById('product-modal').classList.remove('modal-active'); editingProductKey = null; document.getElementById('product-form').reset(); }

        function openOrderDetail(id) {
            const txn = ordersData.find(o => o.id === id);
            if (!txn) return;

            // --- Modal Styling helper ---
            const modalContent = document.querySelector('#order-modal .modal-content');
            if (modalContent) {
                // visual reset to match the "Manifest" look
                modalContent.style.background = '#000000';
                modalContent.style.border = '1px solid #d4af37'; // Gold border
                modalContent.style.boxShadow = '0 0 20px rgba(212, 175, 55, 0.1)';
                modalContent.style.maxWidth = '420px';
                modalContent.style.borderRadius = '0px';
                modalContent.style.padding = '30px';
            }

            // Hide default static headers if they exist (we're injecting our own full layout)
            const staticTitle = document.querySelector('#order-modal h3');
            if (staticTitle) staticTitle.style.display = 'none';
            const staticId = document.getElementById('order-id-display');
            if (staticId) staticId.style.display = 'none';

            // --- Data Prep ---
            const orderIdDisplay = 'OP_' + txn.id.replace('#', '').replace('-', '').slice(-6).toUpperCase();

            // Resolve Address/User
            let contact = txn.userPhone || 'N/A';
            let name = txn.userName || 'Unknown Subject';
            if (!contact && txn.userId) {
                const u = usersData.find(user => user.id === txn.userId);
                if (u) {
                    contact = u.phone;
                    name = u.name;
                }
            }

            // Generate Bag List
            let itemManifestHtml = '';
            if (txn.bags && txn.bags.length > 0) {
                txn.bags.forEach((bag, idx) => {
                    // Get service types with color coding
                    const services = bag.services || bag.service || [];
                    const serviceArray = Array.isArray(services) ? services : [services];

                    const serviceColors = {
                        'iron': { bg: 'rgba(251, 191, 36, 0.15)', text: '#F59E0B', border: '#F59E0B' },
                        'wash': { bg: 'rgba(16, 185, 129, 0.15)', text: '#10B981', border: '#10B981' },
                        'dry': { bg: 'rgba(139, 92, 246, 0.15)', text: '#8B5CF6', border: '#8B5CF6' },
                        'unknown': { bg: 'rgba(128, 128, 128, 0.15)', text: '#888', border: '#888' }
                    };

                    // Create badges for all services
                    const serviceBadges = serviceArray.length > 0
                        ? serviceArray.map(service => {
                            const s = String(service).toLowerCase();
                            const serviceStyle = serviceColors[s] || serviceColors.unknown;
                            return `<span style="display:inline-block; padding:3px 8px; background:${serviceStyle.bg}; color:${serviceStyle.text}; border:1px solid ${serviceStyle.border}; font-size:0.65rem; text-transform:uppercase; letter-spacing:1px; border-radius:3px; margin-left:5px;">${service.toUpperCase()}</span>`;
                        }).join('')
                        : '<span style="display:inline-block; padding:3px 8px; background:rgba(128, 128, 128, 0.15); color:#888; border:1px solid #888; font-size:0.65rem; text-transform:uppercase; letter-spacing:1px; border-radius:3px; margin-left:5px;">UNKNOWN</span>';

                    // Get border color from first service
                    const firstService = serviceArray[0] ? String(serviceArray[0]).toLowerCase() : 'unknown';
                    const borderColor = (serviceColors[firstService] || serviceColors.unknown).border;

                    let itemsStr = '';
                    if (bag.items) {
                        itemsStr = bag.items.map(i => {
                            const iName = i.name || i.category || 'Item';
                            const iQty = i.qty || i.quantity || 1;
                            return `<div style="display:flex; justify-content:space-between; color:#888; font-size:0.8rem; margin-top:2px;">
                                <span>${iName}</span> <span>x${iQty}</span>
                            </div>`;
                        }).join('');
                    }

                    itemManifestHtml += `
                        <div style="background:#111; padding:12px; margin-bottom:10px; border-left: 2px solid ${borderColor};">
                            <div style="font-family:'JetBrains Mono'; color:#fff; font-weight:bold; font-size:0.8rem; text-transform:uppercase; margin-bottom:5px; display:flex; align-items:center;">
                                BAG ${idx + 1}${serviceBadges}
                            </div>
                            <div>${itemsStr || '<i style="font-size:0.7rem; color:#555;">Empty</i>'}</div>
                        </div>
                    `;
                });
            } else {
                itemManifestHtml = `<div style="color:#555; font-style:italic; font-size:0.8rem;">No items recorded in manifest.</div>`;
            }

            // --- Build UI ---
            const html = `
                <div style="font-family: 'JetBrains Mono', monospace; color: #d4af37;">
                    
                    <!-- Header -->
                    <div style="margin-bottom: 30px;">
                        <div style="font-size: 0.65rem; color: #666; letter-spacing: 2px; text-transform: uppercase;">Operation Manifest</div>
                        <div style="font-size: 2.2rem; color: #d4af37; font-weight: 700; line-height: 1.1; margin-top: 5px;">${orderIdDisplay}</div>
                    </div>

                    <!-- Subject Detail -->
                    <div style="margin-bottom: 25px;">
                        <div style="font-size: 0.65rem; color: #666; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px;">Subject Detail</div>
                        <div style="font-size: 1.1rem; color: #fff; font-weight: 400;">${name} <span style="color:#666; font-size:0.8rem;">(${contact})</span></div>
                    </div>

                    <!-- Item Manifest -->
                    <div style="margin-bottom: 30px;">
                        <div style="font-size: 0.65rem; color: #666; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 12px;">Item Manifest</div>
                        <div style="max-height: 250px; overflow-y: auto; padding-right: 5px; scrollbar-color: #333 #000; scrollbar-width: thin;">
                            ${itemManifestHtml}
                        </div>
                    </div>

                    <!-- Footer -->
                    <div style="border-top: 1px solid #333; padding-top: 20px;">
                        <div style="font-size: 1.5rem; color: #d4af37; font-weight: 400; margin-bottom: 25px;">TOTAL: ${txn.total || '₹0'}</div>
                        
                        <div style="display:flex; justify-content: flex-end;">
                            <button onclick="closeOrderDetail()" style="background: transparent; border: 1px solid #d4af37; color: #d4af37; padding: 12px 30px; font-family: 'JetBrains Mono'; text-transform: uppercase; cursor: pointer; transition: all 0.2s; font-size: 0.8rem; letter-spacing: 2px;">
                                DISMISS
                            </button>
                        </div>
                    </div>

                </div>
            `;

            const contentContainer = document.getElementById('order-detail-content');
            contentContainer.innerHTML = html;

            document.getElementById('order-modal').classList.add('modal-active');
        }

        function closeOrderDetail() {
            document.getElementById('order-modal').classList.remove('modal-active');
        }

        function editProduct(key) {
            const p = productsData.find(x => x.dbKey == key);
            if (!p) return;
            editingProductKey = key;
            document.getElementById('prod-name').value = p.name;
            document.getElementById('prod-cat').value = p.cat;
            document.getElementById('prod-desc').value = p.description || '';
            document.getElementById('prod-img').value = p.img;
            document.getElementById('prod-p-iron').value = p.prices?.iron || 0;
            document.getElementById('prod-p-wash').value = p.prices?.wash || 0;
            document.getElementById('prod-p-dry').value = p.prices?.dry || 0;
            openProductModal();
        }

        function openAddressModal() { document.getElementById('address-modal').classList.add('modal-active'); }
        function closeAddressModal() { document.getElementById('address-modal').classList.remove('modal-active'); document.getElementById('address-form').reset(); }

        function closeChatDetail() {
            document.getElementById('chat-detail-modal').classList.remove('modal-active');
            if (adminChat.currentChatId) {
                db.ref(`users/${adminChat.currentChatId}/supportChat/messages`).off('child_added');
            }
        }

        // --- Admin Chat Logic ---
        const adminChat = {
            currentChatId: null,
            chatsData: [],

            updateFromUsers(users) {
                if (!users) {
                    this.chatsData = [];
                } else {
                    this.chatsData = users
                        .filter(u => u.supportChat)
                        .map(u => ({
                            id: u.id, // User ID is the Chat ID
                            userId: u.id,
                            userName: u.name,
                            userPhone: u.phone,
                            ...u.supportChat
                        }))
                        .sort((a, b) => (b.lastMessageTime || 0) - (a.lastMessageTime || 0));
                }
                this.renderChatList();
            },

            loadChats() {
                // No-op: Data is now driven by usersData via updateUI
            },

            renderChatList() {
                const tbody = document.getElementById('support-chats-body');
                if (this.chatsData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:var(--text-mono); padding:30px;">No support chats found</td></tr>';
                    return;
                }

                tbody.innerHTML = this.chatsData.map(chat => {
                    const timeAgo = this.getTimeAgo(chat.lastMessageTime);
                    const status = chat.status || 'active';
                    const statusClass = status === 'resolved' ? 'status-success' : 'status-warning';

                    // Chat object already contains up-to-date user info from updateFromUsers
                    const userName = chat.userName || 'Unknown User';
                    const userPhone = chat.userPhone || 'No phone';

                    // Selection Logic
                    const isSelected = selectedIds.has(chat.id);
                    const rowClass = (isSelectionMode && isSelected) ? 'row-selected' : '';
                    const checkbox = `<div class="select-checkbox ${isSelected ? 'checked' : ''}" style="margin-right:10px; vertical-align:middle;"></div>`;

                    const longPressEvents = `
                        onmousedown="startLongPress('support', '${chat.id}')"
                        ontouchstart="startLongPress('support', '${chat.id}')" 
                        onmouseup="cancelLongPress()" 
                        onmouseleave="cancelLongPress()"
                        ontouchend="cancelLongPress()"
                        onclick="if(isSelectionMode) { event.stopPropagation(); toggleSelection('${chat.id}', 'support'); } else { adminChat.openChat('${chat.id}'); }"
                    `;

                    return `
                        <tr class="${rowClass}" ${longPressEvents} style="cursor:pointer; transition:background 0.2s;">
                            <td style="display:flex; align-items:center;">
                                ${checkbox}
                                <div>
                                    <div style="font-weight:700;">${userName}</div>
                                    <div style="color:var(--text-mono); font-size:0.75rem;">${userPhone}</div>
                                </div>
                            </td>
                            <td style="max-width:300px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                                ${chat.lastMessage || 'No messages'}
                            </td>
                            <td style="font-family:'JetBrains Mono'; font-size:0.75rem; color:var(--text-mono);">
                                ${timeAgo}
                            </td>
                            <td><span class="status-tag ${statusClass}">${status.toUpperCase()}</span></td>
                            <td>
                                <button onclick="event.stopPropagation(); adminChat.openChat('${chat.id}')" class="btn-secondary" style="padding:5px 10px; font-size:0.7rem;">
                                    <i data-lucide="message-square" style="width:12px; vertical-align:middle;"></i> VIEW
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

                try { lucide.createIcons(); } catch (e) { }
            },

            openChat(chatId) {
                this.currentChatId = chatId;
                const chat = this.chatsData.find(c => c.id === chatId);

                if (!chat) return;

                // Update chat user info
                document.getElementById('chat-user-info').innerHTML = `
                    ${chat.userName || 'Unknown'} • ${chat.userPhone || 'No phone'}
                `;

                // Clear previous messages
                const container = document.getElementById('admin-chat-messages');
                container.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">Loading secure channel...</div>';

                // Listen for new messages
                this.listenForNewMessages(chatId);

                // Show modal
                document.getElementById('chat-detail-modal').classList.add('modal-active');
            },

            listenForNewMessages(chatId) {
                // Clean up previous listener if any
                db.ref(`users/${chatId}/supportChat/messages`).off('child_added');

                // Clear container before starting to listen
                const container = document.getElementById('admin-chat-messages');
                container.innerHTML = '';

                // Listen for new messages
                db.ref(`users/${chatId}/supportChat/messages`).orderByKey().limitToLast(100).on('child_added', snapshot => {
                    const msg = snapshot.val();
                    if (!msg) return;

                    // Check if message already exists (deduplication)
                    if (container && !container.querySelector(`[data-msg-time="${msg.timestamp}"]`)) {
                        this.addMessageToChat(msg);
                        this.scrollChatToBottom();
                    }
                });
            },

            addMessageToChat(msg) {
                const container = document.getElementById('admin-chat-messages');
                const messageDiv = document.createElement('div');
                messageDiv.setAttribute('data-msg-time', msg.timestamp);

                const isAdmin = msg.sender === 'admin';
                const align = isAdmin ? 'flex-end' : 'flex-start';
                const bgColor = isAdmin ? 'var(--accent)' : '#111';
                const textColor = isAdmin ? '#000' : '#fff';
                const borderRadius = isAdmin ? '18px 18px 4px 18px' : '18px 18px 18px 4px';

                messageDiv.style.cssText = `display:flex; justify-content:${align}; margin-bottom:12px;`;

                // Format time
                let timeStr = '';
                try {
                    timeStr = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                } catch (e) { timeStr = 'Now'; }

                messageDiv.innerHTML = `
                    <div style="background:${bgColor}; color:${textColor}; padding:12px 16px; border-radius:${borderRadius}; max-width:70%; border:1px solid var(--border); box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
                        <div style="font-size:0.85rem; line-height:1.5;">${msg.message}</div>
                        <div style="font-size:0.65rem; opacity:0.7; margin-top:5px; font-family:'JetBrains Mono'; text-align:right;">
                            ${timeStr}
                        </div>
                    </div>
                `;

                container.appendChild(messageDiv);
            },

            sendReply() {
                const input = document.getElementById('admin-chat-input');
                const message = input.value.trim();

                if (!message || !this.currentChatId) return;

                const messageData = {
                    sender: 'admin',
                    senderName: 'Support Team',
                    message: message,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };

                const chatRef = db.ref(`users/${this.currentChatId}/supportChat`);

                // Save to Firebase
                chatRef.child('messages').push(messageData).then(() => {
                    // Update chat metadata
                    chatRef.update({
                        lastMessage: 'You: ' + message,
                        lastMessageTime: firebase.database.ServerValue.TIMESTAMP,
                        updatedAt: firebase.database.ServerValue.TIMESTAMP,
                        status: 'active'
                    });

                    input.value = '';
                }).catch(err => {
                    console.error('❌ Error sending reply:', err);
                    alert('Failed to send reply. Check console.');
                });
            },

            scrollChatToBottom() {
                const container = document.getElementById('admin-chat-messages');
                if (container) {
                    // Use RAF to ensure render is complete
                    requestAnimationFrame(() => {
                        container.scrollTop = container.scrollHeight;
                    });
                }
            },

            getTimeAgo(timestamp) {
                if (!timestamp) return 'Unknown';
                const seconds = Math.floor((Date.now() - timestamp) / 1000);
                if (seconds < 60) return 'Just now';
                const minutes = Math.floor(seconds / 60);
                if (minutes < 60) return `${minutes}m ago`;
                const hours = Math.floor(minutes / 60);
                if (hours < 24) return `${hours}h ago`;
                const days = Math.floor(hours / 24);
                return `${days}d ago`;
            }
        };

        // --- Authentication ---
        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('login-error');

            errorDiv.style.display = 'none';
            errorDiv.innerText = '';

            firebase.auth().signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Signed in
                    console.log("Authenticated");
                })
                .catch((error) => {
                    console.error(error);
                    errorDiv.innerText = "ACCESS DENIED: " + error.message;
                    errorDiv.style.display = 'block';
                });
        }

        function handleLogout() {
            firebase.auth().signOut().then(() => {
                console.log("Session Terminated");
            }).catch((error) => {
                console.error(error);
            });
        }

        // Auth State Observer
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                // User is signed in
                document.getElementById('login-screen').style.display = 'none';
                const appContent = document.getElementById('app-content');
                appContent.style.display = 'flex'; // Restore flex layout

                // Initialize Data
                if (ordersData.length === 0) { // Prevent double-fetch
                    initCharts();
                    fetchData();
                    adminChat.loadChats();
                }
            } else {
                // User is signed out
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('app-content').style.display = 'none';

                // Clear Sensitive Data from UI (Optional, but good practice)
                ordersData = [];
                usersData = [];
                updateUI();
            }
        });

        // Start (Removed auto-start, now driven by Auth State)
        // initCharts();
        // fetchData();
        // adminChat.loadChats(); 

    </script>
</body>

</html>
